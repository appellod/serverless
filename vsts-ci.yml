resources:
- repo: self
queue:
  name: continuous-integration
  demands: npm

steps:
- task: DockerCompose@0
  displayName: 'Docker Compose: up -d'
  inputs:
    dockerComposeCommand: 'up -d'

- task: Npm@1
  displayName: 'NPM: install'
  inputs:
    command: custom
    verbose: false
    customCommand: ci

- task: Npm@1
  displayName: 'NPM: run test:vsts'
  inputs:
    command: custom
    verbose: false
    customCommand: 'run test:vsts'


- task: PublishTestResults@2
  displayName: 'Publish Test Results: Mocha'
  inputs:
    testResultsFiles: 'test-results.xml'
    searchFolder: '$(System.DefaultWorkingDirectory)/.test-results'

- task: PublishCodeCoverageResults@1
  displayName: 'Publish Code Coverage: NYC'
  inputs:
    codeCoverageTool: Cobertura
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/.test-results/coverage/cobertura-coverage.xml'
    reportDirectory: '$(System.DefaultWorkingDirectory)/.test-results/coverage-vsts'

- task: DockerCompose@0
  displayName: 'Docker Compose: stop'
  inputs:
    dockerComposeCommand: stop
  continueOnError: true
  condition: always()

